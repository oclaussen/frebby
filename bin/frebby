#!/usr/bin/env ruby
# frozen_string_literal: true

#
# Copyright 2017, Ole Claussen <claussen.ole@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
require 'forwardable'
require 'json'

class Frebby
  extend Forwardable

  def initialize(**initial)
    @hash = initial.clone
  end

  def_delegators :@hash, :[], :[]=, :to_json

  def respond_to_missing?(_symbol, _respond_to = false)
    true
  end

  def method_missing(name, *args, **kwargs, &blk)
    no_value = (kwargs.empty? && !block_given?)
    return super if args.empty? && no_value

    args.unshift(name)
    if no_value
      value = args.pop
    else
      value = Frebby.new(**kwargs)
      value.instance_eval(&blk) if block_given?
    end
    Frebby._set_value(@hash, value, *args)
  end

  class << self
    def _transform_key(key)
      key.to_s
    end

    def _transform_value(value, key, target)
      existing = target[key]
      if existing.nil?
        value
      elsif existing.is_a?(Array)
        (existing + [value])
      else
        [existing, value]
      end
    end

    def _set_value(target, value, *keys)
      raise '_set_value keys empty. This should not happen' if keys.empty?
      raise "Error: #{target} is not a Hash" unless target.respond_to?(:[])

      key = _transform_key(keys.shift)
      if keys.empty?
        target[key] = _transform_value(value, key, target)
      else
        _set_value(target[key] ||= Frebby.new, value, *keys)
      end
    end
  end
end

hash = Frebby.new
hash.instance_eval(ARGF.read)
puts hash.to_json
