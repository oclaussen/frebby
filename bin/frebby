#!/usr/bin/env ruby
# frozen_string_literal: true

#
# Copyright 2017, Ole Claussen <claussen.ole@gmail.com>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
require 'forwardable'
require 'json'

class Frebby
  extend Forwardable

  def initialize
    @hash = {}
  end

  def_delegators :@hash, :[], :[]=, :to_json

  def respond_to_missing?(_symbol, _respond_to = false)
    true
  end

  # rubocop thinks this class is too complicated. Shut up, rubocop.
  # rubocop:disable Metrics/AbcSize, Metrics/CyclomaticComplexity
  # rubocop:disable Metrics/MethodLength, Metrics/PerceivedComplexity
  def method_missing(name, *args, **kwargs, &blk)
    return super if args.empty? && kwargs.empty? && !block_given?
    raise 'Invalid Syntax' if !kwargs.empty? && block_given?

    args.unshift(name)

    if block_given?
      value = Frebby.new
      value.instance_eval(&blk)
    elsif !kwargs.empty?
      value = kwargs
    else
      value = args.pop
    end

    Frebby._set_value(@hash, value, *args)
  end
  # rubocop:enable Metrics/AbcSize, Metrics/CyclomaticComplexity
  # rubocop:enable Metrics/MethodLength, Metrics/PerceivedComplexity

  class << self
    def _transform_key(key)
      key.to_s
    end

    def _transform_value(value, key, target)
      existing = target[key]
      if existing.nil?
        value
      elsif existing.is_a?(Array)
        (existing + [value])
      else
        [existing, value]
      end
    end

    def _set_value(target, value, *keys)
      raise '_set_value keys empty. This should not happen' if keys.empty?
      raise 'Invalid Syntax' if !target.is_a?(Hash) && !target.is_a?(Frebby)

      key = _transform_key(keys.shift)
      if keys.empty?
        target[key] = _transform_value(value, key, target)
      else
        _set_value(target[key] ||= Frebby.new, value, *keys)
      end
    end
  end
end

hash = Frebby.new
hash.instance_eval(ARGF.read)
puts hash.to_json
